<!-- Step 4: R Code Execution & AI Assistant Component -->
<!-- Extracted from real_ui.html - Full functionality restored -->

<div id="step4-container" class="step-container" style="display: none;">
    <div class="step-section">
        <h2>ğŸš€ STEP 4: R Code Execution & AI Assistant</h2>
        <p><strong>Execute R code with AI-powered debugging and interactive assistance</strong></p>

        <!-- Navigation Controls -->
        <div style="margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between;">
            <button onclick="goBackToStep3()" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">
                â† Back to Step 3
            </button>
            <div style="display: flex; gap: 10px; align-items: center;">
                <span style="background: linear-gradient(135deg, #6f42c1 0%, #8e44ad 100%); color: white; padding: 8px 16px; border-radius: 20px; font-weight: bold; font-size: 13px;">
                    ğŸ¤– AI-Powered Execution
                </span>
            </div>
        </div>

        <!-- Main Two-Column Layout -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">

            <!-- LEFT COLUMN: R Code Editor -->
            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                    <h4 style="color: #495057; margin: 0; border-bottom: 2px solid #007bff; padding-bottom: 8px;">ğŸ“ R Code Editor & Comparison</h4>
                    <div style="display: flex; gap: 6px;">
                        <button id="load-from-step3-btn" onclick="loadFromStep3()" style="background: #28a745; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 10px;">
                            ğŸ“¥ Load
                        </button>
                        <button onclick="validateRCodeInEditor()" style="background: #17a2b8; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 10px;">
                            âœ… Check
                        </button>
                        <button onclick="showCodeVersionHistory()" style="background: #6f42c1; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 10px;">
                            ğŸ“š History
                        </button>
                        <button onclick="clearRCodeEditor()" style="background: #6c757d; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 10px;">
                            ğŸ—‘ï¸ Clear
                        </button>
                        <button onclick="minimalRCodeTest()" style="background: #dc3545; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 10px;">
                            ğŸ§ª Test
                        </button>
                        <button onclick="minimalBackendTest()" style="background: #fd7e14; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 10px;">
                            ğŸŒ Backend
                        </button>
                        <button onclick="comprehensiveTest()" style="background: #6f42c1; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 10px;">
                            ğŸ”¬ Full Test
                        </button>
                    </div>
                </div>

                <!-- Code View Tabs -->
                <div id="code-view-tabs" style="background: #f8f9fa; border-radius: 6px 6px 0 0; border-bottom: 1px solid #e9ecef; display: flex; margin-bottom: 0;">
                    <button id="tab-editor" onclick="switchCodeView('editor')" style="background: #007bff; color: white; border: none; padding: 10px 16px; cursor: pointer; font-size: 11px; flex: 1; font-weight: bold; border-radius: 6px 0 0 0;">
                        âœï¸ Editor
                    </button>
                    <button id="tab-original" onclick="switchCodeView('original')" style="background: #6c757d; color: white; border: none; padding: 10px 16px; cursor: pointer; font-size: 11px; flex: 1; font-weight: bold; display: none;">
                        ğŸ“„ Original
                    </button>
                    <button id="tab-final" onclick="switchCodeView('final')" style="background: #6c757d; color: white; border: none; padding: 10px 16px; cursor: pointer; font-size: 11px; flex: 1; font-weight: bold; display: none;">
                        âœ… Final
                    </button>
                    <button id="tab-changes" onclick="switchCodeView('changes')" style="background: #6c757d; color: white; border: none; padding: 10px 16px; cursor: pointer; font-size: 11px; flex: 1; font-weight: bold; border-radius: 0 6px 0 0; display: none;">
                        ğŸ” Changes
                    </button>
                </div>

                <!-- Code Display Container -->
                <div style="position: relative; border: 2px solid #e9ecef; border-radius: 0 0 8px 8px; background: #f8f9fa;">

                    <!-- Editor View -->
                    <div id="view-editor" style="position: relative;">
                        <textarea id="step4-rcode-editor" placeholder="# Enter your R code here or load from Step 3

# Example:
library(dplyr)
library(haven)

# Load clinical data
data <- read_sas('data.sas7bdat')

# Perform analysis
result <- data %>%
  group_by(treatment) %>%
  summarise(n = n(), mean_age = mean(age))

print(result)"
                            style="width: 100%; height: 350px; padding: 15px; border: none; border-radius: 0 0 6px 6px; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.4; resize: vertical; background: #f8f9fa;"
                            oninput="updateRCodeFromEditor()"></textarea>

                        <!-- Status Indicator -->
                        <div id="code-status-indicator" style="position: absolute; top: 10px; right: 10px; background: #28a745; color: white; padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; display: none;">
                            âœ… Ready
                        </div>
                    </div>

                    <!-- Original Code View -->
                    <div id="view-original" style="display: none; padding: 15px; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.4; max-height: 350px; overflow-y: auto; background: #fff3cd; border-radius: 0 0 6px 6px;">
                        <div style="color: #856404; font-weight: bold; margin-bottom: 10px;">ğŸ“„ Original Code from Step 3:</div>
                        <pre id="original-code-content" style="margin: 0; white-space: pre-wrap; color: #495057;">// Original R code will appear here</pre>
                    </div>

                    <!-- Final Code View -->
                    <div id="view-final" style="display: none; padding: 15px; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.4; max-height: 350px; overflow-y: auto; background: #d4edda; border-radius: 0 0 6px 6px;">
                        <div style="color: #155724; font-weight: bold; margin-bottom: 10px;">âœ… Final Working Code:</div>
                        <pre id="final-code-content" style="margin: 0; white-space: pre-wrap; color: #495057;">// Final R code will appear here</pre>
                    </div>

                    <!-- Changes View -->
                    <div id="view-changes" style="display: none; padding: 15px; font-size: 13px; line-height: 1.4; max-height: 350px; overflow-y: auto; background: #e2e3f0; border-radius: 0 0 6px 6px;">
                        <div style="color: #383d41; font-weight: bold; margin-bottom: 10px;">ğŸ” AI Assistant Changes:</div>
                        <div id="changes-content" style="color: #495057;">// Changes summary will appear here</div>
                    </div>
                </div>

                <!-- Code Source Info -->
                <div id="code-source-info" style="margin-top: 10px; padding: 10px; background: #e7f3ff; border-radius: 6px; border-left: 4px solid #007bff; display: none;">
                    <div style="font-size: 11px; color: #0056b3; font-weight: bold;">
                        <span id="code-source-text">âœ… Code loaded from Step 3</span>
                    </div>
                </div>

                <!-- Execution Button -->
                <div style="margin-top: 15px;">
                    <button id="execute-step4-btn" onclick="executeRCodeStep4()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 13px; width: 100%; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                        ğŸš€ Execute R Code with AI Debugging
                    </button>
                    <div id="step4-execution-status" style="display: none; background: #fff3cd; color: #856404; padding: 8px 12px; border-radius: 6px; font-size: 11px; font-weight: bold; margin-top: 8px; text-align: center;">
                        â³ Executing R code...
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN: AI Assistant -->
            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                    <h4 style="color: #495057; margin: 0; border-bottom: 2px solid #6f42c1; padding-bottom: 8px;">ğŸ¤– Interactive AI Assistant</h4>
                    <div style="display: flex; gap: 6px;">
                        <button id="interrupt-btn" onclick="interruptExecution()" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px; display: none;">
                            ğŸ›‘ Stop
                        </button>
                        <button onclick="continueSession()" style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px;" title="Continue session (preserve history)">
                            â–¶ï¸ Continue
                        </button>
                        <button onclick="restartSession()" style="background: #ffc107; color: black; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px;" title="Restart session (clear history)">
                            ğŸ”„ Restart
                        </button>
                        <div id="session-status-indicator" style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: bold;">
                            ğŸ”´ NOT READY
                        </div>
                    </div>
                </div>

                <!-- Interactive Chat Area -->
                <div id="ai-chat-area" style="height: 280px; overflow-y: auto; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                    <div class="ai-message" style="margin-bottom: 12px; padding: 10px; background: white; border-radius: 8px; border-left: 4px solid #6f42c1;">
                        <div style="font-weight: bold; color: #6f42c1; margin-bottom: 5px; font-size: 11px;">ğŸ¤– Interactive AI Assistant</div>
                        <div style="font-size: 12px; color: #495057; line-height: 1.4;">
                            ğŸš€ <strong>Interactive R Analysis Ready!</strong><br><br>
                            I can execute R code in real-time and help with:
                            <br>â€¢ ğŸ“Š Clinical data analysis & statistics
                            <br>â€¢ ğŸ“‹ Table, listing, figure (TLF) generation
                            <br>â€¢ ğŸ”§ Code debugging & optimization
                            <br>â€¢ ğŸ’¡ Clinical insights & interpretation
                            <br><br>
                            <em>Just ask me to analyze your data or generate specific outputs!</em>
                        </div>
                    </div>
                </div>

                <!-- Interactive Chat Input -->
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="ai-chat-input" placeholder="Ask AI to analyze data, generate code, or debug issues..." style="flex: 1; padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 6px; font-size: 12px;" onkeypress="if(event.key==='Enter') sendInteractiveMessage()">
                    <button id="send-message-btn" onclick="sendInteractiveMessage()" style="background: #6f42c1; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: bold;">
                        ğŸš€ Send
                    </button>
                </div>

                <!-- Interactive Quick Actions -->
                <div style="margin-top: 10px; display: flex; gap: 4px; flex-wrap: wrap;">
                    <button onclick="sendQuickMessage('Analyze the loaded dataset and show summary')" style="background: #007bff; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 10px;">
                        ğŸ“Š Analyze Data
                    </button>
                    <button onclick="sendQuickMessage('Generate summary statistics table')" style="background: #17a2b8; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 10px;">
                        ğŸ“ˆ Summary Stats
                    </button>
                    <button onclick="sendQuickMessage('Create a clinical demographics table')" style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 10px;">
                        ğŸ“‹ Demographics
                    </button>
                    <button onclick="debugCurrentCode()" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 10px;">
                        ğŸ”§ Debug Code
                    </button>
                    <button onclick="debugCodeTransfer()" style="background: #6f42c1; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 10px;" title="Test if AI can see the current R code">
                        ğŸ” Test Code Transfer
                    </button>
                </div>
            </div>
        </div>

        <!-- Execution Log & Progress Panel -->
        <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                <h4 style="color: #495057; margin: 0; border-bottom: 2px solid #17a2b8; padding-bottom: 8px;">âš¡ Execution Log & Progress</h4>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <div id="iteration-counter" style="background: #e9ecef; color: #6c757d; padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: bold;">
                        Ready
                    </div>
                    <div id="execution-status-indicator" style="background: #ffc107; color: #212529; padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: bold;">
                        IDLE
                    </div>
                </div>
            </div>

            <!-- Progress Bar -->
            <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                    <span style="font-size: 12px; color: #6c757d; font-weight: bold;">Progress:</span>
                    <div style="flex: 1; background: #e9ecef; border-radius: 10px; height: 6px; overflow: hidden;">
                        <div id="execution-progress-bar" style="background: linear-gradient(90deg, #28a745, #20c997); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                    </div>
                    <span id="execution-progress-text" style="font-size: 11px; color: #6c757d;">0%</span>
                </div>
                <div style="display: flex; gap: 15px; font-size: 11px;">
                    <span style="color: #6c757d;">Time: <span id="execution-time-display">0s</span></span>
                    <span style="color: #6c757d;">Files: <span id="execution-files-count">0</span></span>
                    <span style="color: #6c757d;">Iteration: <span id="execution-iteration-display">0/3</span></span>
                </div>
            </div>

            <!-- Execution Log Display -->
            <div id="execution-log-display" style="height: 200px; overflow-y: auto; background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 11px; line-height: 1.4;">
                <div style="color: #569cd6;">ğŸ¤– R Code Execution System v2.0</div>
                <div style="color: #6a9955;">Ready for AI-powered R code execution with iterative debugging...</div>
                <div style="color: #4ec9b0;">Mode: <span id="execution-current-mode">AI-Powered Execution</span></div>
                <div style="margin: 10px 0; color: #d7ba7d;">
                    <span style="color: #569cd6;">></span> <span id="execution-cursor" style="animation: blink 1s infinite;">_</span>
                </div>
            </div>

            <!-- Log Controls -->
            <div style="margin-top: 15px; display: flex; gap: 8px; justify-content: center;">
                <button onclick="clearExecutionLog()" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                    ğŸ—‘ï¸ Clear Log
                </button>
                <button onclick="showCodeVersionHistory()" style="background: #6f42c1; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                    ğŸ“š Version History
                </button>
                <button onclick="exportExecutionLog()" style="background: #17a2b8; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                    ğŸ“¥ Export Log
                </button>
            </div>
        </div>

        <!-- Results Display -->
        <div id="step4-results" style="display: none; margin-bottom: 20px;">
            <!-- Results Header -->
            <div style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                <h3 style="margin: 0; font-weight: bold; font-size: 18px;">ğŸ“Š Execution Results</h3>
            </div>

            <!-- Results Content -->
            <div style="background: white; border-radius: 0 0 12px 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow: hidden;">
                <!-- Clinical Table Results -->
                <div style="padding: 20px; border-bottom: 1px solid #e9ecef;">
                    <h4 style="color: #495057; margin: 0 0 15px 0;">ğŸ“‹ Clinical Table Output</h4>
                    <div id="step4-clinical-output" style="background: #f8f9fa; padding: 15px; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.4; max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6;">
                        <div style="text-align: center; color: #6c757d; padding: 20px;">
                            <div style="font-size: 18px; margin-bottom: 8px;">ğŸ“‹</div>
                            <div>Execute R code to see console output here</div>
                            <div style="font-size: 12px; margin-top: 5px;">R execution results and messages will be displayed</div>
                        </div>
                    </div>
                </div>

                <!-- Generated Files & Results -->
                <div style="padding: 20px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h4 style="color: #495057; margin: 0;">ğŸ“ Generated Files & Results</h4>
                        <div style="display: flex; gap: 8px;">
                            <button id="expand-all-files" onclick="expandAllFiles()" style="background: #007bff; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                ğŸ“– Expand All
                            </button>
                            <button id="collapse-all-files" onclick="collapseAllFiles()" style="background: #6c757d; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                ğŸ“• Collapse All
                            </button>
                        </div>
                    </div>
                    <div id="step4-files-list" style="background: #f8f9fa; padding: 15px; border-radius: 6px; border: 1px solid #dee2e6; min-height: 60px;">
                        <div style="text-align: center; color: #6c757d; padding: 20px;">
                            <div style="font-size: 24px; margin-bottom: 10px;">ğŸ“„</div>
                            <div>Generated files will appear here after execution</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
