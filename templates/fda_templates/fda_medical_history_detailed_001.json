{
  "id": "fda-medical-history-detailed-001",
  "title": "Table 14.1.2 Medical History",
  "type": "table",
  "category": "demographics",
  "fda_compliance": {
    "standard": "ICH E3 Section 14.1.2",
    "population": "Safety Population",
    "statistical_method": "Descriptive Statistics",
    "quality_checks": ["data_validation", "statistical_review", "clinical_review", "medical_coding"],
    "regulatory_requirements": [
      "FDA Guidance for Industry: E3 Structure and Content of Clinical Study Reports",
      "ICH E3 Guidelines Section 14.1",
      "CDISC ADaM Implementation Guide",
      "Medical History Coding Guidelines"
    ]
  },
  "template_structure": {
    "title": "Table 14.1.2 Medical History",
    "subtitle": "Prior Medical Conditions and Concomitant Medications by Treatment Group",
    "table_type": "medical_history",
    "columns": [
      {
        "name": "Medical History Category",
        "type": "text",
        "description": "Category of medical history"
      },
      {
        "name": "Condition/Medication",
        "type": "text",
        "description": "Specific condition or medication"
      },
      {
        "name": "Treatment A",
        "type": "statistical",
        "description": "n/N (%) for Treatment A",
        "statistics": ["condition_count", "total_count", "percentage"]
      },
      {
        "name": "Treatment B",
        "type": "statistical",
        "description": "n/N (%) for Treatment B",
        "statistics": ["condition_count", "total_count", "percentage"]
      },
      {
        "name": "Placebo",
        "type": "statistical",
        "description": "n/N (%) for Placebo",
        "statistics": ["condition_count", "total_count", "percentage"]
      },
      {
        "name": "Total",
        "type": "statistical",
        "description": "n/N (%) for Total",
        "statistics": ["condition_count", "total_count", "percentage"]
      },
      {
        "name": "Treatment A vs Placebo",
        "type": "comparison",
        "description": "Risk Difference (95% CI)",
        "statistics": ["risk_difference", "ci_lower", "ci_upper", "p_value"]
      },
      {
        "name": "Treatment B vs Placebo",
        "type": "comparison",
        "description": "Risk Difference (95% CI)",
        "statistics": ["risk_difference", "ci_lower", "ci_upper", "p_value"]
      },
      {
        "name": "Clinical Relevance",
        "type": "text",
        "description": "Clinical significance assessment"
      }
    ],
    "rows": [
      {
        "category": "Prior Medical Conditions",
        "conditions": [
          {
            "name": "Cardiovascular Disorders",
            "paramcd": "CARDIOVASCULAR",
            "category": "Prior Medical Conditions",
            "baseline_var": "MH_CARDIOVASCULAR",
            "coding_system": "MedDRA",
            "clinical_threshold": "High"
          },
          {
            "name": "Endocrine Disorders",
            "paramcd": "ENDOCRINE",
            "category": "Prior Medical Conditions",
            "baseline_var": "MH_ENDOCRINE",
            "coding_system": "MedDRA",
            "clinical_threshold": "Medium"
          },
          {
            "name": "Gastrointestinal Disorders",
            "paramcd": "GASTROINTESTINAL",
            "category": "Prior Medical Conditions",
            "baseline_var": "MH_GASTROINTESTINAL",
            "coding_system": "MedDRA",
            "clinical_threshold": "Medium"
          },
          {
            "name": "Hepatic Disorders",
            "paramcd": "HEPATIC",
            "category": "Prior Medical Conditions",
            "baseline_var": "MH_HEPATIC",
            "coding_system": "MedDRA",
            "clinical_threshold": "High"
          },
          {
            "name": "Renal Disorders",
            "paramcd": "RENAL",
            "category": "Prior Medical Conditions",
            "baseline_var": "MH_RENAL",
            "coding_system": "MedDRA",
            "clinical_threshold": "High"
          },
          {
            "name": "Respiratory Disorders",
            "paramcd": "RESPIRATORY",
            "category": "Prior Medical Conditions",
            "baseline_var": "MH_RESPIRATORY",
            "coding_system": "MedDRA",
            "clinical_threshold": "Medium"
          },
          {
            "name": "Neurological Disorders",
            "paramcd": "NEUROLOGICAL",
            "category": "Prior Medical Conditions",
            "baseline_var": "MH_NEUROLOGICAL",
            "coding_system": "MedDRA",
            "clinical_threshold": "High"
          },
          {
            "name": "Psychiatric Disorders",
            "paramcd": "PSYCHIATRIC",
            "category": "Prior Medical Conditions",
            "baseline_var": "MH_PSYCHIATRIC",
            "coding_system": "MedDRA",
            "clinical_threshold": "Medium"
          },
          {
            "name": "Oncological Disorders",
            "paramcd": "ONCOLOGICAL",
            "category": "Prior Medical Conditions",
            "baseline_var": "MH_ONCOLOGICAL",
            "coding_system": "MedDRA",
            "clinical_threshold": "High"
          },
          {
            "name": "Immunological Disorders",
            "paramcd": "IMMUNOLOGICAL",
            "category": "Prior Medical Conditions",
            "baseline_var": "MH_IMMUNOLOGICAL",
            "coding_system": "MedDRA",
            "clinical_threshold": "High"
          }
        ]
      },
      {
        "category": "Concomitant Medications",
        "conditions": [
          {
            "name": "Cardiovascular Medications",
            "paramcd": "CM_CARDIOVASCULAR",
            "category": "Concomitant Medications",
            "baseline_var": "CM_CARDIOVASCULAR",
            "coding_system": "WHO Drug",
            "clinical_threshold": "High"
          },
          {
            "name": "Endocrine Medications",
            "paramcd": "CM_ENDOCRINE",
            "category": "Concomitant Medications",
            "baseline_var": "CM_ENDOCRINE",
            "coding_system": "WHO Drug",
            "clinical_threshold": "Medium"
          },
          {
            "name": "Gastrointestinal Medications",
            "paramcd": "CM_GASTROINTESTINAL",
            "category": "Concomitant Medications",
            "baseline_var": "CM_GASTROINTESTINAL",
            "coding_system": "WHO Drug",
            "clinical_threshold": "Medium"
          },
          {
            "name": "Analgesics",
            "paramcd": "CM_ANALGESICS",
            "category": "Concomitant Medications",
            "baseline_var": "CM_ANALGESICS",
            "coding_system": "WHO Drug",
            "clinical_threshold": "Medium"
          },
          {
            "name": "Anticoagulants",
            "paramcd": "CM_ANTICOAGULANTS",
            "category": "Concomitant Medications",
            "baseline_var": "CM_ANTICOAGULANTS",
            "coding_system": "WHO Drug",
            "clinical_threshold": "High"
          },
          {
            "name": "Antiplatelet Agents",
            "paramcd": "CM_ANTIPLATELET",
            "category": "Concomitant Medications",
            "baseline_var": "CM_ANTIPLATELET",
            "coding_system": "WHO Drug",
            "clinical_threshold": "High"
          },
          {
            "name": "Psychotropic Medications",
            "paramcd": "CM_PSYCHOTROPIC",
            "category": "Concomitant Medications",
            "baseline_var": "CM_PSYCHOTROPIC",
            "coding_system": "WHO Drug",
            "clinical_threshold": "Medium"
          },
          {
            "name": "Antidiabetic Medications",
            "paramcd": "CM_ANTIDIABETIC",
            "category": "Concomitant Medications",
            "baseline_var": "CM_ANTIDIABETIC",
            "coding_system": "WHO Drug",
            "clinical_threshold": "High"
          },
          {
            "name": "Antihypertensive Medications",
            "paramcd": "CM_ANTIHYPERTENSIVE",
            "category": "Concomitant Medications",
            "baseline_var": "CM_ANTIHYPERTENSIVE",
            "coding_system": "WHO Drug",
            "clinical_threshold": "High"
          },
          {
            "name": "Lipid-Lowering Medications",
            "paramcd": "CM_LIPID_LOWERING",
            "category": "Concomitant Medications",
            "baseline_var": "CM_LIPID_LOWERING",
            "coding_system": "WHO Drug",
            "clinical_threshold": "Medium"
          }
        ]
      }
    ],
    "footnotes": [
      "Safety Population: All randomized subjects who received at least one dose of study drug",
      "Prior Medical Conditions: Medical conditions present at baseline",
      "Concomitant Medications: Medications taken during the study period",
      "Risk Difference: Difference in prevalence rates between treatment groups",
      "95% CI: 95% confidence interval",
      "p-values from chi-square test or Fisher's exact test",
      "Clinical Relevance: Assessment of clinical significance based on condition/medication type",
      "Coding Systems: MedDRA for medical conditions, WHO Drug for medications",
      "Treatment A: High dose, Treatment B: Low dose"
    ],
    "statistical_methodology": {
      "primary_method": "Descriptive Statistics",
      "prevalence_calculation": "Number of subjects with condition/medication divided by total subjects",
      "risk_difference": "Difference in prevalence proportions between treatment groups",
      "confidence_intervals": "Wilson confidence intervals for proportions",
      "significance_test": "Chi-square test or Fisher's exact test",
      "significance_level": 0.05,
      "confidence_level": 0.95
    }
  },
  "r_code": {
    "libraries": [
      "library(tidyverse)",
      "library(haven)",
      "library(lubridate)",
      "library(gt)",
      "library(flextable)",
      "library(broom)",
      "library(PropCIs)"
    ],
    "data_preparation": [
      "# Load datasets",
      "adsl <- read_sas('data/adsl.sas7bdat')",
      "admh <- read_sas('data/admh.sas7bdat')",
      "adcm <- read_sas('data/adcm.sas7bdat')",
      "",
      "# Filter for Safety population",
      "adsl_safety <- adsl %>% filter(SAFFL == 'Y')",
      "",
      "# Merge datasets",
      "analysis_data <- adsl_safety %>%",
      "  left_join(admh, by = 'USUBJID') %>%",
      "  left_join(adcm, by = 'USUBJID') %>%",
      "  mutate(",
      "    TRT01P = factor(TRT01P, levels = c('Placebo', 'Treatment B', 'Treatment A'))",
      "  )",
      "",
      "# Define medical history categories",
      "medical_history_categories <- list(",
      "  CARDIOVASCULAR = list(",
      "    label = 'Cardiovascular Disorders',",
      "    category = 'Prior Medical Conditions',",
      "    coding_system = 'MedDRA',",
      "    clinical_threshold = 'High'",
      "  ),",
      "  ENDOCRINE = list(",
      "    label = 'Endocrine Disorders',",
      "    category = 'Prior Medical Conditions',",
      "    coding_system = 'MedDRA',",
      "    clinical_threshold = 'Medium'",
      "  ),",
      "  GASTROINTESTINAL = list(",
      "    label = 'Gastrointestinal Disorders',",
      "    category = 'Prior Medical Conditions',",
      "    coding_system = 'MedDRA',",
      "    clinical_threshold = 'Medium'",
      "  ),",
      "  HEPATIC = list(",
      "    label = 'Hepatic Disorders',",
      "    category = 'Prior Medical Conditions',",
      "    coding_system = 'MedDRA',",
      "    clinical_threshold = 'High'",
      "  ),",
      "  RENAL = list(",
      "    label = 'Renal Disorders',",
      "    category = 'Prior Medical Conditions',",
      "    coding_system = 'MedDRA',",
      "    clinical_threshold = 'High'",
      "  ),",
      "  RESPIRATORY = list(",
      "    label = 'Respiratory Disorders',",
      "    category = 'Prior Medical Conditions',",
      "    coding_system = 'MedDRA',",
      "    clinical_threshold = 'Medium'",
      "  ),",
      "  NEUROLOGICAL = list(",
      "    label = 'Neurological Disorders',",
      "    category = 'Prior Medical Conditions',",
      "    coding_system = 'MedDRA',",
      "    clinical_threshold = 'High'",
      "  ),",
      "  PSYCHIATRIC = list(",
      "    label = 'Psychiatric Disorders',",
      "    category = 'Prior Medical Conditions',",
      "    coding_system = 'MedDRA',",
      "    clinical_threshold = 'Medium'",
      "  ),",
      "  ONCOLOGICAL = list(",
      "    label = 'Oncological Disorders',",
      "    category = 'Prior Medical Conditions',",
      "    coding_system = 'MedDRA',",
      "    clinical_threshold = 'High'",
      "  ),",
      "  IMMUNOLOGICAL = list(",
      "    label = 'Immunological Disorders',",
      "    category = 'Prior Medical Conditions',",
      "    coding_system = 'MedDRA',",
      "    clinical_threshold = 'High'",
      "  )",
      ")",
      "",
      "concomitant_medication_categories <- list(",
      "  CM_CARDIOVASCULAR = list(",
      "    label = 'Cardiovascular Medications',",
      "    category = 'Concomitant Medications',",
      "    coding_system = 'WHO Drug',",
      "    clinical_threshold = 'High'",
      "  ),",
      "  CM_ENDOCRINE = list(",
      "    label = 'Endocrine Medications',",
      "    category = 'Concomitant Medications',",
      "    coding_system = 'WHO Drug',",
      "    clinical_threshold = 'Medium'",
      "  ),",
      "  CM_GASTROINTESTINAL = list(",
      "    label = 'Gastrointestinal Medications',",
      "    category = 'Concomitant Medications',",
      "    coding_system = 'WHO Drug',",
      "    clinical_threshold = 'Medium'",
      "  ),",
      "  CM_ANALGESICS = list(",
      "    label = 'Analgesics',",
      "    category = 'Concomitant Medications',",
      "    coding_system = 'WHO Drug',",
      "    clinical_threshold = 'Medium'",
      "  ),",
      "  CM_ANTICOAGULANTS = list(",
      "    label = 'Anticoagulants',",
      "    category = 'Concomitant Medications',",
      "    coding_system = 'WHO Drug',",
      "    clinical_threshold = 'High'",
      "  ),",
      "  CM_ANTIPLATELET = list(",
      "    label = 'Antiplatelet Agents',",
      "    category = 'Concomitant Medications',",
      "    coding_system = 'WHO Drug',",
      "    clinical_threshold = 'High'",
      "  ),",
      "  CM_PSYCHOTROPIC = list(",
      "    label = 'Psychotropic Medications',",
      "    category = 'Concomitant Medications',",
      "    coding_system = 'WHO Drug',",
      "    clinical_threshold = 'Medium'",
      "  ),",
      "  CM_ANTIDIABETIC = list(",
      "    label = 'Antidiabetic Medications',",
      "    category = 'Concomitant Medications',",
      "    coding_system = 'WHO Drug',",
      "    clinical_threshold = 'High'",
      "  ),",
      "  CM_ANTIHYPERTENSIVE = list(",
      "    label = 'Antihypertensive Medications',",
      "    category = 'Concomitant Medications',",
      "    coding_system = 'WHO Drug',",
      "    clinical_threshold = 'High'",
      "  ),",
      "  CM_LIPID_LOWERING = list(",
      "    label = 'Lipid-Lowering Medications',",
      "    category = 'Concomitant Medications',",
      "    coding_system = 'WHO Drug',",
      "    clinical_threshold = 'Medium'",
      "  )",
      ")"
    ],
    "statistical_analysis": [
      "# Function to calculate medical history prevalence",
      "calculate_medical_history_prevalence <- function(data, param_code, category_info) {",
      "  # Create binary variable for presence of condition/medication",
      "  if (str_detect(param_code, '^CM_')) {",
      "    # Concomitant medications",
      "    prevalence_data <- data %>%",
      "      group_by(USUBJID, TRT01P) %>%",
      "      summarise(",
      "        has_condition = ifelse(any(!is.na(CMDECOD) & CMDECOD != ''), 1, 0),",
      "        .groups = 'drop'",
      "      )",
      "  } else {",
      "    # Prior medical conditions",
      "    prevalence_data <- data %>%",
      "      group_by(USUBJID, TRT01P) %>%",
      "      summarise(",
      "        has_condition = ifelse(any(!is.na(MHDECOD) & MHDECOD != ''), 1, 0),",
      "        .groups = 'drop'",
      "      )",
      "  }",
      "  ",
      "  # Calculate prevalence by treatment group",
      "  prevalence_summary <- prevalence_data %>%",
      "    group_by(TRT01P) %>%",
      "    summarise(",
      "      n_with_condition = sum(has_condition),",
      "      n_total = n(),",
      "      prevalence = n_with_condition / n_total,",
      "      percentage = prevalence * 100,",
      "      .groups = 'drop'",
      "    )",
      "  ",
      "  # Calculate total across all treatment groups",
      "  total_summary <- prevalence_data %>%",
      "    summarise(",
      "      n_with_condition = sum(has_condition),",
      "      n_total = n(),",
      "      prevalence = n_with_condition / n_total,",
      "      percentage = prevalence * 100,",
      "      .groups = 'drop'",
      "    ) %>%",
      "    mutate(TRT01P = 'Total')",
      "  ",
      "  # Combine treatment groups and total",
      "  all_summary <- rbind(prevalence_summary, total_summary)",
      "  ",
      "  return(all_summary)",
      "}",
      "",
      "# Function to calculate risk differences",
      "calculate_medical_history_risk_differences <- function(prevalence_data) {",
      "  # Get placebo prevalence",
      "  placebo_data <- prevalence_data %>% filter(TRT01P == 'Placebo')",
      "  ",
      "  if (nrow(placebo_data) == 0) {",
      "    return(data.frame())",
      "  }",
      "  ",
      "  placebo_rate <- placebo_data$prevalence",
      "  ",
      "  # Calculate risk differences for treatment groups",
      "  risk_diffs <- prevalence_data %>%",
      "    filter(TRT01P != 'Placebo' & TRT01P != 'Total') %>%",
      "    mutate(",
      "      risk_diff = prevalence - placebo_rate,",
      "      # Wilson confidence interval for risk difference",
      "      se_diff = sqrt(prevalence * (1 - prevalence) / n_total + placebo_rate * (1 - placebo_rate) / n_total),",
      "      ci_lower = risk_diff - 1.96 * se_diff,",
      "      ci_upper = risk_diff + 1.96 * se_diff,",
      "      # Chi-square test",
      "      p_value = chisq.test(matrix(c(n_with_condition, n_total - n_with_condition, placebo_data$n_with_condition, placebo_data$n_total - placebo_data$n_with_condition), nrow = 2))$p.value",
      "    )",
      "  ",
      "  return(risk_diffs)",
      "}",
      "",
      "# Calculate prevalence for all medical history categories",
      "medical_history_results <- list()",
      "for (param in names(medical_history_categories)) {",
      "  medical_history_results[[param]] <- calculate_medical_history_prevalence(",
      "    analysis_data,",
      "    param,",
      "    medical_history_categories[[param]]",
      "  )",
      "}",
      "",
      "# Calculate prevalence for all concomitant medication categories",
      "concomitant_medication_results <- list()",
      "for (param in names(concomitant_medication_categories)) {",
      "  concomitant_medication_results[[param]] <- calculate_medical_history_prevalence(",
      "    analysis_data,",
      "    param,",
      "    concomitant_medication_categories[[param]]",
      "  )",
      "}",
      "",
      "# Calculate risk differences",
      "medical_history_risk_diffs <- list()",
      "for (param in names(medical_history_results)) {",
      "  medical_history_risk_diffs[[param]] <- calculate_medical_history_risk_differences(",
      "    medical_history_results[[param]]",
      "  )",
      "}",
      "",
      "concomitant_medication_risk_diffs <- list()",
      "for (param in names(concomitant_medication_results)) {",
      "  concomitant_medication_risk_diffs[[param]] <- calculate_medical_history_risk_differences(",
      "    concomitant_medication_results[[param]]",
      "  )",
      "}"
    ],
    "table_generation": [
      "# Function to create medical history summary table",
      "create_medical_history_table <- function(mh_results, cm_results, mh_risk_diffs, cm_risk_diffs, mh_categories, cm_categories) {",
      "  table_data <- data.frame()",
      "  ",
      "  # Process medical history results",
      "  for (param in names(mh_results)) {",
      "    result <- mh_results[[param]]",
      "    category_info <- mh_categories[[param]]",
      "    risk_diffs <- mh_risk_diffs[[param]]",
      "    ",
      "    # Get treatment group summaries",
      "    trt_a <- result %>% filter(TRT01P == 'Treatment A')",
      "    trt_a_rate <- sprintf('%d/%d (%.1f%%)', trt_a$n_with_condition, trt_a$n_total, trt_a$percentage)",
      "    ",
      "    trt_b <- result %>% filter(TRT01P == 'Treatment B')",
      "    trt_b_rate <- sprintf('%d/%d (%.1f%%)', trt_b$n_with_condition, trt_b$n_total, trt_b$percentage)",
      "    ",
      "    placebo <- result %>% filter(TRT01P == 'Placebo')",
      "    placebo_rate <- sprintf('%d/%d (%.1f%%)', placebo$n_with_condition, placebo$n_total, placebo$percentage)",
      "    ",
      "    total <- result %>% filter(TRT01P == 'Total')",
      "    total_rate <- sprintf('%d/%d (%.1f%%)', total$n_with_condition, total$n_total, total$percentage)",
      "    ",
      "    # Risk differences",
      "    trt_a_rd <- risk_diffs %>% filter(TRT01P == 'Treatment A')",
      "    trt_a_rd_ci <- ifelse(nrow(trt_a_rd) > 0, sprintf('%.3f (%.3f, %.3f)', trt_a_rd$risk_diff, trt_a_rd$ci_lower, trt_a_rd$ci_upper), 'N/A')",
      "    trt_a_p <- ifelse(nrow(trt_a_rd) > 0, sprintf('%.4f', trt_a_rd$p_value), 'N/A')",
      "    ",
      "    trt_b_rd <- risk_diffs %>% filter(TRT01P == 'Treatment B')",
      "    trt_b_rd_ci <- ifelse(nrow(trt_b_rd) > 0, sprintf('%.3f (%.3f, %.3f)', trt_b_rd$risk_diff, trt_b_rd$ci_lower, trt_b_rd$ci_upper), 'N/A')",
      "    trt_b_p <- ifelse(nrow(trt_b_rd) > 0, sprintf('%.4f', trt_b_rd$p_value), 'N/A')",
      "    ",
      "    # Clinical relevance",
      "    clinical_relevance <- category_info$clinical_threshold",
      "    ",
      "    # Add to table data",
      "    row_data <- data.frame(",
      "      Category = category_info$category,",
      "      Condition_Medication = category_info$label,",
      "      Treatment_A = trt_a_rate,",
      "      Treatment_B = trt_b_rate,",
      "      Placebo = placebo_rate,",
      "      Total = total_rate,",
      "      Treatment_A_vs_Placebo = trt_a_rd_ci,",
      "      Treatment_B_vs_Placebo = trt_b_rd_ci,",
      "      Clinical_Relevance = clinical_relevance",
      "    )",
      "    ",
      "    table_data <- rbind(table_data, row_data)",
      "  }",
      "  ",
      "  # Process concomitant medication results",
      "  for (param in names(cm_results)) {",
      "    result <- cm_results[[param]]",
      "    category_info <- cm_categories[[param]]",
      "    risk_diffs <- cm_risk_diffs[[param]]",
      "    ",
      "    # Get treatment group summaries",
      "    trt_a <- result %>% filter(TRT01P == 'Treatment A')",
      "    trt_a_rate <- sprintf('%d/%d (%.1f%%)', trt_a$n_with_condition, trt_a$n_total, trt_a$percentage)",
      "    ",
      "    trt_b <- result %>% filter(TRT01P == 'Treatment B')",
      "    trt_b_rate <- sprintf('%d/%d (%.1f%%)', trt_b$n_with_condition, trt_b$n_total, trt_b$percentage)",
      "    ",
      "    placebo <- result %>% filter(TRT01P == 'Placebo')",
      "    placebo_rate <- sprintf('%d/%d (%.1f%%)', placebo$n_with_condition, placebo$n_total, placebo$percentage)",
      "    ",
      "    total <- result %>% filter(TRT01P == 'Total')",
      "    total_rate <- sprintf('%d/%d (%.1f%%)', total$n_with_condition, total$n_total, total$percentage)",
      "    ",
      "    # Risk differences",
      "    trt_a_rd <- risk_diffs %>% filter(TRT01P == 'Treatment A')",
      "    trt_a_rd_ci <- ifelse(nrow(trt_a_rd) > 0, sprintf('%.3f (%.3f, %.3f)', trt_a_rd$risk_diff, trt_a_rd$ci_lower, trt_a_rd$ci_upper), 'N/A')",
      "    trt_a_p <- ifelse(nrow(trt_a_rd) > 0, sprintf('%.4f', trt_a_rd$p_value), 'N/A')",
      "    ",
      "    trt_b_rd <- risk_diffs %>% filter(TRT01P == 'Treatment B')",
      "    trt_b_rd_ci <- ifelse(nrow(trt_b_rd) > 0, sprintf('%.3f (%.3f, %.3f)', trt_b_rd$risk_diff, trt_b_rd$ci_lower, trt_b_rd$ci_upper), 'N/A')",
      "    trt_b_p <- ifelse(nrow(trt_b_rd) > 0, sprintf('%.4f', trt_b_rd$p_value), 'N/A')",
      "    ",
      "    # Clinical relevance",
      "    clinical_relevance <- category_info$clinical_threshold",
      "    ",
      "    # Add to table data",
      "    row_data <- data.frame(",
      "      Category = category_info$category,",
      "      Condition_Medication = category_info$label,",
      "      Treatment_A = trt_a_rate,",
      "      Treatment_B = trt_b_rate,",
      "      Placebo = placebo_rate,",
      "      Total = total_rate,",
      "      Treatment_A_vs_Placebo = trt_a_rd_ci,",
      "      Treatment_B_vs_Placebo = trt_b_rd_ci,",
      "      Clinical_Relevance = clinical_relevance",
      "    )",
      "    ",
      "    table_data <- rbind(table_data, row_data)",
      "  }",
      "  ",
      "  return(table_data)",
      "}",
      "",
      "# Generate table",
      "medical_history_table_data <- create_medical_history_table(",
      "  medical_history_results,",
      "  concomitant_medication_results,",
      "  medical_history_risk_diffs,",
      "  concomitant_medication_risk_diffs,",
      "  medical_history_categories,",
      "  concomitant_medication_categories",
      ")",
      "",
      "# Create formatted table",
      "medical_history_table <- medical_history_table_data %>%",
      "  gt() %>%",
      "  tab_header(",
      "    title = 'Table 14.1.2 Medical History',",
      "    subtitle = 'Prior Medical Conditions and Concomitant Medications by Treatment Group'",
      "  ) %>%",
      "  cols_label(",
      "    Category = 'Medical History Category',",
      "    Condition_Medication = 'Condition/Medication',",
      "    Treatment_A = 'Treatment A<br>n/N (%)',",
      "    Treatment_B = 'Treatment B<br>n/N (%)',",
      "    Placebo = 'Placebo<br>n/N (%)',",
      "    Total = 'Total<br>n/N (%)',",
      "    Treatment_A_vs_Placebo = 'Treatment A vs Placebo<br>Risk Difference (95% CI)',",
      "    Treatment_B_vs_Placebo = 'Treatment B vs Placebo<br>Risk Difference (95% CI)',",
      "    Clinical_Relevance = 'Clinical Relevance'",
      "  ) %>%",
      "  tab_style(",
      "    style = cell_text(weight = 'bold'),",
      "    locations = cells_column_labels()",
      "  ) %>%",
      "  tab_style(",
      "    style = cell_borders(",
      "      sides = 'bottom',",
      "      weight = px(2)",
      "    ),",
      "    locations = cells_body(",
      "      rows = c(10, 20)",
      "    )",
      "  ) %>%",
      "  fmt_markdown(columns = everything()) %>%",
      "  tab_footnote(",
      "    footnote = 'Safety Population: All randomized subjects who received at least one dose of study drug',",
      "    locations = cells_title()",
      "  ) %>%",
      "  tab_footnote(",
      "    footnote = 'Prior Medical Conditions: Medical conditions present at baseline',",
      "    locations = cells_title()",
      "  ) %>%",
      "  tab_footnote(",
      "    footnote = 'Concomitant Medications: Medications taken during the study period',",
      "    locations = cells_title()",
      "  ) %>%",
      "  tab_footnote(",
      "    footnote = 'Risk Difference: Difference in prevalence rates between treatment groups',",
      "    locations = cells_title()",
      "  )",
      "",
      "# Display table",
      "medical_history_table"
    ],
    "quality_checks": [
      "# Data validation checks",
      "data_validation <- analysis_data %>%",
      "  group_by(TRT01P) %>%",
      "  summarise(",
      "    n_subjects = n_distinct(USUBJID),",
      "    n_with_mh = sum(!is.na(MHDECOD) & MHDECOD != ''),",
      "    n_with_cm = sum(!is.na(CMDECOD) & CMDECOD != ''),",
      "    mh_completeness = n_with_mh / n_subjects * 100,",
      "    cm_completeness = n_with_cm / n_subjects * 100,",
      "    .groups = 'drop'",
      "  )",
      "",
      "# Statistical validation",
      "statistical_validation <- list()",
      "for (param in names(medical_history_results)) {",
      "  result <- medical_history_results[[param]]",
      "  ",
      "  # Check for sufficient sample sizes",
      "  sample_sizes <- result %>%",
      "    filter(TRT01P != 'Total') %>%",
      "    summarise(",
      "      min_n = min(n_total),",
      "      max_n = max(n_total),",
      "      .groups = 'drop'",
      "    )",
      "  ",
      "  # Check for expected cell counts (for chi-square test)",
      "  expected_counts <- result %>%",
      "    filter(TRT01P != 'Total') %>%",
      "    summarise(",
      "      total_condition = sum(n_with_condition),",
      "      total_subjects = sum(n_total),",
      "      .groups = 'drop'",
      "    ) %>%",
      "    mutate(",
      "      expected_count = total_condition / 3,  # Assuming 3 treatment groups",
      "      chi_square_valid = expected_count >= 5",
      "    )",
      "  ",
      "  statistical_validation[[param]] <- list(",
      "    sample_sizes = sample_sizes,",
      "    expected_counts = expected_counts,",
      "    chi_square_valid = all(expected_counts$chi_square_valid)",
      "  )",
      "}",
      "",
      "# Clinical validation",
      "clinical_validation <- list()",
      "for (param in names(medical_history_results)) {",
      "  risk_diffs <- medical_history_risk_diffs[[param]]",
      "  category_info <- medical_history_categories[[param]]",
      "  ",
      "  # Check for clinically significant differences",
      "  clinically_significant_diffs <- risk_diffs %>%",
      "    filter(abs(risk_diff) >= 0.05) %>%",
      "    nrow()",
      "  ",
      "  # Check for high clinical relevance conditions",
      "  high_relevance <- category_info$clinical_threshold == 'High'",
      "  ",
      "  clinical_validation[[param]] <- list(",
      "    clinically_significant_count = clinically_significant_diffs,",
      "    high_relevance = high_relevance,",
      "    clinical_threshold = category_info$clinical_threshold",
      "  )",
      "}",
      "",
      "# Medical coding validation",
      "coding_validation <- list()",
      "for (param in names(medical_history_categories)) {",
      "  category_info <- medical_history_categories[[param]]",
      "  ",
      "  # Check coding system compliance",
      "  coding_compliance <- analysis_data %>%",
      "    filter(!is.na(MHDECOD) & MHDECOD != '') %>%",
      "    summarise(",
      "      n_coded = n(),",
      "      n_with_system = sum(!is.na(MHTERM)),",
      "      coding_completeness = n_with_system / n_coded * 100,",
      "      .groups = 'drop'",
      "    )",
      "  ",
      "  coding_validation[[param]] <- list(",
      "    coding_compliance = coding_compliance,",
      "    coding_system = category_info$coding_system",
      "  )",
      "}",
      "",
      "# Print validation results",
      "cat('Data Validation:\\n')",
      "print(data_validation)",
      "cat('\\nStatistical Validation:\\n')",
      "print(statistical_validation)",
      "cat('\\nClinical Validation:\\n')",
      "print(clinical_validation)",
      "cat('\\nCoding Validation:\\n')",
      "print(coding_validation)"
    ],
    "export_functions": [
      "# Export medical history analysis results",
      "export_medical_history_results <- function(table_data, mh_results, cm_results, mh_risk_diffs, cm_risk_diffs, output_dir = 'output') {",
      "  # Create output directory",
      "  if (!dir.exists(output_dir)) {",
      "    dir.create(output_dir, recursive = TRUE)",
      "  }",
      "  ",
      "  # Export HTML table",
      "  html_file <- file.path(output_dir, 'medical_history_table.html')",
      "  medical_history_table %>%",
      "    gtsave(html_file)",
      "  ",
      "  # Export RTF table",
      "  rtf_file <- file.path(output_dir, 'medical_history_table.rtf')",
      "  medical_history_table_data %>%",
      "    flextable() %>%",
      "    set_header_labels(",
      "      Category = 'Medical History Category',",
      "      Condition_Medication = 'Condition/Medication',",
      "      Treatment_A = 'Treatment A\\nn/N (%)',",
      "      Treatment_B = 'Treatment B\\nn/N (%)',",
      "      Placebo = 'Placebo\\nn/N (%)',",
      "      Total = 'Total\\nn/N (%)',",
      "      Treatment_A_vs_Placebo = 'Treatment A vs Placebo\\nRisk Difference (95% CI)',",
      "      Treatment_B_vs_Placebo = 'Treatment B vs Placebo\\nRisk Difference (95% CI)',",
      "      Clinical_Relevance = 'Clinical Relevance'",
      "    ) %>%",
      "    autofit() %>%",
      "    save_as_rtf(rtf_file)",
      "  ",
      "  # Export results summary",
      "  summary_file <- file.path(output_dir, 'medical_history_summary.txt')",
      "  sink(summary_file)",
      "  cat('Medical History Analysis Summary\\n')",
      "  cat('==============================\\n\\n')",
      "  ",
      "  cat('Prior Medical Conditions:\\n')",
      "  for (param in names(mh_results)) {",
      "    cat(sprintf('Parameter: %s\\n', param))",
      "    print(mh_results[[param]])",
      "    if (nrow(mh_risk_diffs[[param]]) > 0) {",
      "      cat('Risk Differences:\\n')",
      "      print(mh_risk_diffs[[param]])",
      "    }",
      "    cat('\\n')",
      "  }",
      "  ",
      "  cat('Concomitant Medications:\\n')",
      "  for (param in names(cm_results)) {",
      "    cat(sprintf('Parameter: %s\\n', param))",
      "    print(cm_results[[param]])",
      "    if (nrow(cm_risk_diffs[[param]]) > 0) {",
      "      cat('Risk Differences:\\n')",
      "      print(cm_risk_diffs[[param]])",
      "    }",
      "    cat('\\n')",
      "  }",
      "  ",
      "  cat('Statistical Method: Descriptive Statistics\\n')",
      "  cat('Population: Safety Population\\n')",
      "  cat('Significance Level: 0.05\\n')",
      "  cat('Coding Systems: MedDRA for medical conditions, WHO Drug for medications\\n')",
      "  sink()",
      "  ",
      "  cat('Exported files to:', output_dir, '\\n')",
      "}",
      "",
      "# Export results",
      "export_medical_history_results(medical_history_table_data, medical_history_results, concomitant_medication_results, medical_history_risk_diffs, concomitant_medication_risk_diffs)"
    ]
  },
  "keywords": [
    "medical history",
    "prior medical conditions",
    "concomitant medications",
    "prevalence analysis",
    "risk difference",
    "clinical relevance",
    "MedDRA coding",
    "WHO Drug coding",
    "safety population",
    "FDA compliance",
    "ICH E3",
    "clinical trial",
    "statistical analysis"
  ],
  "metadata": {
    "created_date": "2024-08-06",
    "version": "1.0",
    "author": "Jaime Yan",
    "description": "FDA-compliant medical history template with detailed structure and complete R code",
    "references": [
      "ICH E3 Guidelines Section 14.1.2",
      "FDA Guidance for Industry: E3 Structure and Content of Clinical Study Reports",
      "CDISC ADaM Implementation Guide",
      "Medical History Coding Guidelines",
      "Statistical Analysis Plan Template"
    ],
    "data_requirements": [
      "ADSL dataset with SAFFL flag",
      "ADMH dataset with medical history variables",
      "ADCM dataset with concomitant medication variables",
      "Medical history variables: MHDECOD, MHTERM, MHBODSYS",
      "Concomitant medication variables: CMDECOD, CMTERM, CMBODSYS",
      "Treatment assignment: TRT01P",
      "Coding systems: MedDRA for medical conditions, WHO Drug for medications"
    ],
    "statistical_methods": [
      "Descriptive statistics for prevalence calculations",
      "Risk differences with 95% confidence intervals",
      "Chi-square test or Fisher's exact test for significance",
      "Clinical relevance assessment using pre-specified thresholds",
      "Medical coding validation and completeness checks"
    ]
  }
} 