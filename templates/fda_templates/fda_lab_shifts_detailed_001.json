{
  "id": "fda-lab-shifts-detailed-001",
  "title": "Table 14.3.5 Laboratory Shifts Analysis",
  "type": "table",
  "category": "safety",
  "fda_compliance": {
    "standard": "ICH E3 Section 14.3.5",
    "population": "Safety Population",
    "statistical_method": "Shift Table Analysis",
    "quality_checks": ["data_validation", "statistical_review", "clinical_review", "reference_ranges"],
    "regulatory_requirements": [
      "FDA Guidance for Industry: E3 Structure and Content of Clinical Study Reports",
      "ICH E3 Guidelines Section 14.3",
      "CDISC ADaM Implementation Guide",
      "Laboratory Safety Monitoring Guidelines"
    ]
  },
  "template_structure": {
    "title": "Table 14.3.5 Laboratory Shifts Analysis",
    "subtitle": "Normal to Abnormal Shift Tables by Treatment Group",
    "table_type": "laboratory_shifts",
    "columns": [
      {
        "name": "Parameter",
        "type": "text",
        "description": "Laboratory parameter name"
      },
      {
        "name": "Category",
        "type": "text",
        "description": "Laboratory category (Hematology/Chemistry)"
      },
      {
        "name": "Shift Category",
        "type": "text",
        "description": "Shift from baseline to post-baseline"
      },
      {
        "name": "Treatment A",
        "type": "statistical",
        "description": "n/N (%) for Treatment A",
        "statistics": ["shift_count", "total_count", "percentage"]
      },
      {
        "name": "Treatment B",
        "type": "statistical",
        "description": "n/N (%) for Treatment B",
        "statistics": ["shift_count", "total_count", "percentage"]
      },
      {
        "name": "Placebo",
        "type": "statistical",
        "description": "n/N (%) for Placebo",
        "statistics": ["shift_count", "total_count", "percentage"]
      },
      {
        "name": "Treatment A vs Placebo",
        "type": "comparison",
        "description": "Risk Difference (95% CI)",
        "statistics": ["risk_difference", "ci_lower", "ci_upper", "p_value"]
      },
      {
        "name": "Treatment B vs Placebo",
        "type": "comparison",
        "description": "Risk Difference (95% CI)",
        "statistics": ["risk_difference", "ci_lower", "ci_upper", "p_value"]
      },
      {
        "name": "Clinically Significant",
        "type": "text",
        "description": "Clinical significance assessment"
      }
    ],
    "rows": [
      {
        "category": "Hematology",
        "parameters": [
          {
            "name": "Hemoglobin",
            "paramcd": "HGB",
            "category": "Hematology",
            "baseline_var": "BASE_HGB",
            "post_var": "POST_HGB",
            "baseline_ref": "ANRIND_BASE_HGB",
            "post_ref": "ANRIND_POST_HGB",
            "clinical_threshold": "Low"
          },
          {
            "name": "White Blood Cell Count",
            "paramcd": "WBC",
            "category": "Hematology",
            "baseline_var": "BASE_WBC",
            "post_var": "POST_WBC",
            "baseline_ref": "ANRIND_BASE_WBC",
            "post_ref": "ANRIND_POST_WBC",
            "clinical_threshold": "High"
          },
          {
            "name": "Platelet Count",
            "paramcd": "PLT",
            "category": "Hematology",
            "baseline_var": "BASE_PLT",
            "post_var": "POST_PLT",
            "baseline_ref": "ANRIND_BASE_PLT",
            "post_ref": "ANRIND_POST_PLT",
            "clinical_threshold": "Low"
          },
          {
            "name": "Neutrophil Count",
            "paramcd": "NEUT",
            "category": "Hematology",
            "baseline_var": "BASE_NEUT",
            "post_var": "POST_NEUT",
            "baseline_ref": "ANRIND_BASE_NEUT",
            "post_ref": "ANRIND_POST_NEUT",
            "clinical_threshold": "Low"
          }
        ]
      },
      {
        "category": "Chemistry",
        "parameters": [
          {
            "name": "Alanine Aminotransferase",
            "paramcd": "ALT",
            "category": "Chemistry",
            "baseline_var": "BASE_ALT",
            "post_var": "POST_ALT",
            "baseline_ref": "ANRIND_BASE_ALT",
            "post_ref": "ANRIND_POST_ALT",
            "clinical_threshold": "High"
          },
          {
            "name": "Aspartate Aminotransferase",
            "paramcd": "AST",
            "category": "Chemistry",
            "baseline_var": "BASE_AST",
            "post_var": "POST_AST",
            "baseline_ref": "ANRIND_BASE_AST",
            "post_ref": "ANRIND_POST_AST",
            "clinical_threshold": "High"
          },
          {
            "name": "Alkaline Phosphatase",
            "paramcd": "ALP",
            "category": "Chemistry",
            "baseline_var": "BASE_ALP",
            "post_var": "POST_ALP",
            "baseline_ref": "ANRIND_BASE_ALP",
            "post_ref": "ANRIND_POST_ALP",
            "clinical_threshold": "High"
          },
          {
            "name": "Total Bilirubin",
            "paramcd": "TBIL",
            "category": "Chemistry",
            "baseline_var": "BASE_TBIL",
            "post_var": "POST_TBIL",
            "baseline_ref": "ANRIND_BASE_TBIL",
            "post_ref": "ANRIND_POST_TBIL",
            "clinical_threshold": "High"
          },
          {
            "name": "Creatinine",
            "paramcd": "CREAT",
            "category": "Chemistry",
            "baseline_var": "BASE_CREAT",
            "post_var": "POST_CREAT",
            "baseline_ref": "ANRIND_BASE_CREAT",
            "post_ref": "ANRIND_POST_CREAT",
            "clinical_threshold": "High"
          },
          {
            "name": "Blood Urea Nitrogen",
            "paramcd": "BUN",
            "category": "Chemistry",
            "baseline_var": "BASE_BUN",
            "post_var": "POST_BUN",
            "baseline_ref": "ANRIND_BASE_BUN",
            "post_ref": "ANRIND_POST_BUN",
            "clinical_threshold": "High"
          },
          {
            "name": "Glucose",
            "paramcd": "GLUC",
            "category": "Chemistry",
            "baseline_var": "BASE_GLUC",
            "post_var": "POST_GLUC",
            "baseline_ref": "ANRIND_BASE_GLUC",
            "post_ref": "ANRIND_POST_GLUC",
            "clinical_threshold": "High"
          },
          {
            "name": "Sodium",
            "paramcd": "SODIUM",
            "category": "Chemistry",
            "baseline_var": "BASE_SODIUM",
            "post_var": "POST_SODIUM",
            "baseline_ref": "ANRIND_BASE_SODIUM",
            "post_ref": "ANRIND_POST_SODIUM",
            "clinical_threshold": "Low"
          },
          {
            "name": "Potassium",
            "paramcd": "POTASSIUM",
            "category": "Chemistry",
            "baseline_var": "BASE_POTASSIUM",
            "post_var": "POST_POTASSIUM",
            "baseline_ref": "ANRIND_BASE_POTASSIUM",
            "post_ref": "ANRIND_POST_POTASSIUM",
            "clinical_threshold": "High"
          }
        ]
      }
    ],
    "shift_categories": [
      "Normal → Normal",
      "Normal → High",
      "Normal → Low",
      "High → Normal",
      "High → High",
      "High → Low",
      "Low → Normal",
      "Low → High",
      "Low → Low"
    ],
    "footnotes": [
      "Safety Population: All randomized subjects who received at least one dose of study drug",
      "Shift: Change from baseline to post-baseline reference range category",
      "Normal: Within reference range",
      "High: Above upper limit of normal",
      "Low: Below lower limit of normal",
      "Risk Difference: Difference in shift rates between treatment groups",
      "95% CI: 95% confidence interval",
      "p-values from chi-square test or Fisher's exact test",
      "Clinically significant: Shifts to abnormal values requiring clinical attention",
      "Treatment A: High dose, Treatment B: Low dose"
    ],
    "statistical_methodology": {
      "primary_method": "Shift Table Analysis",
      "shift_calculation": "Cross-tabulation of baseline vs post-baseline reference ranges",
      "risk_difference": "Difference in shift proportions between treatment groups",
      "confidence_intervals": "Wilson confidence intervals for proportions",
      "significance_test": "Chi-square test or Fisher's exact test",
      "significance_level": 0.05,
      "confidence_level": 0.95
    }
  },
  "r_code": {
    "libraries": [
      "library(tidyverse)",
      "library(haven)",
      "library(lubridate)",
      "library(gt)",
      "library(flextable)",
      "library(broom)",
      "library(PropCIs)"
    ],
    "data_preparation": [
      "# Load datasets",
      "adsl <- read_sas('data/adsl.sas7bdat')",
      "adlb <- read_sas('data/adlb.sas7bdat')",
      "",
      "# Filter for Safety population",
      "adsl_safety <- adsl %>% filter(SAFFL == 'Y')",
      "",
      "# Merge datasets",
      "analysis_data <- adlb %>%",
      "  inner_join(adsl_safety, by = 'USUBJID') %>%",
      "  filter(PARAMCD %in% c('HGB', 'WBC', 'PLT', 'NEUT', 'ALT', 'AST', 'ALP', 'TBIL', 'CREAT', 'BUN', 'GLUC', 'SODIUM', 'POTASSIUM')) %>%",
      "  filter(AVISIT %in% c('Baseline', 'Week 12')) %>%",
      "  mutate(",
      "    TRT01P = factor(TRT01P, levels = c('Placebo', 'Treatment B', 'Treatment A')),",
      "    AVISIT = factor(AVISIT, levels = c('Baseline', 'Week 12')),",
      "    PARAM_LABEL = case_when(",
      "      PARAMCD == 'HGB' ~ 'Hemoglobin',",
      "      PARAMCD == 'WBC' ~ 'White Blood Cell Count',",
      "      PARAMCD == 'PLT' ~ 'Platelet Count',",
      "      PARAMCD == 'NEUT' ~ 'Neutrophil Count',",
      "      PARAMCD == 'ALT' ~ 'Alanine Aminotransferase',",
      "      PARAMCD == 'AST' ~ 'Aspartate Aminotransferase',",
      "      PARAMCD == 'ALP' ~ 'Alkaline Phosphatase',",
      "      PARAMCD == 'TBIL' ~ 'Total Bilirubin',",
      "      PARAMCD == 'CREAT' ~ 'Creatinine',",
      "      PARAMCD == 'BUN' ~ 'Blood Urea Nitrogen',",
      "      PARAMCD == 'GLUC' ~ 'Glucose',",
      "      PARAMCD == 'SODIUM' ~ 'Sodium',",
      "      PARAMCD == 'POTASSIUM' ~ 'Potassium'",
      "    ),",
      "    CATEGORY = case_when(",
      "      PARAMCD %in% c('HGB', 'WBC', 'PLT', 'NEUT') ~ 'Hematology',",
      "      TRUE ~ 'Chemistry'",
      "    )",
      "  )",
      "",
      "# Create shift data",
      "baseline_data <- analysis_data %>%",
      "  filter(AVISIT == 'Baseline') %>%",
      "  select(USUBJID, PARAMCD, ANRIND) %>%",
      "  rename(BASELINE_ANRIND = ANRIND)",
      "",
      "post_data <- analysis_data %>%",
      "  filter(AVISIT == 'Week 12') %>%",
      "  select(USUBJID, PARAMCD, ANRIND) %>%",
      "  rename(POST_ANRIND = ANRIND)",
      "",
      "# Merge baseline and post data",
      "shift_data <- baseline_data %>%",
      "  inner_join(post_data, by = c('USUBJID', 'PARAMCD')) %>%",
      "  mutate(",
      "    SHIFT_CATEGORY = paste(BASELINE_ANRIND, '→', POST_ANRIND)",
      "  ) %>%",
      "  left_join(adsl_safety %>% select(USUBJID, TRT01P), by = 'USUBJID')"
    ],
    "statistical_analysis": [
      "# Function to create shift table for a parameter",
      "create_shift_table <- function(data, param_code) {",
      "  param_data <- data %>% filter(PARAMCD == param_code)",
      "  ",
      "  # Create shift table",
      "  shift_table <- param_data %>%",
      "    group_by(TRT01P, SHIFT_CATEGORY) %>%",
      "    summarise(",
      "      n_shifts = n(),",
      "      .groups = 'drop'",
      "    ) %>%",
      "    group_by(TRT01P) %>%",
      "    mutate(",
      "      total_n = sum(n_shifts),",
      "      percentage = n_shifts / total_n * 100",
      "    ) %>%",
      "    ungroup()",
      "  ",
      "  return(shift_table)",
      "}",
      "",
      "# Function to calculate risk differences",
      "calculate_risk_differences <- function(shift_table, shift_category) {",
      "  # Get counts for specific shift category",
      "  shift_counts <- shift_table %>%",
      "    filter(SHIFT_CATEGORY == shift_category)",
      "  ",
      "  # Calculate risk differences",
      "  placebo_count <- shift_counts %>% filter(TRT01P == 'Placebo') %>% pull(n_shifts)",
      "  placebo_total <- shift_counts %>% filter(TRT01P == 'Placebo') %>% pull(total_n)",
      "  ",
      "  if (length(placebo_count) == 0) {",
      "    return(data.frame())",
      "  }",
      "  ",
      "  risk_diffs <- shift_counts %>%",
      "    filter(TRT01P != 'Placebo') %>%",
      "    mutate(",
      "      placebo_rate = placebo_count / placebo_total,",
      "      treatment_rate = n_shifts / total_n,",
      "      risk_diff = treatment_rate - placebo_rate,",
      "      # Wilson confidence interval for risk difference",
      "      se_diff = sqrt(treatment_rate * (1 - treatment_rate) / total_n + placebo_rate * (1 - placebo_rate) / placebo_total),",
      "      ci_lower = risk_diff - 1.96 * se_diff,",
      "      ci_upper = risk_diff + 1.96 * se_diff,",
      "      # Chi-square test",
      "      p_value = chisq.test(matrix(c(n_shifts, total_n - n_shifts, placebo_count, placebo_total - placebo_count), nrow = 2))$p.value",
      "    )",
      "  ",
      "  return(risk_diffs)",
      "}",
      "",
      "# Laboratory parameters",
      "lab_params <- c('HGB', 'WBC', 'PLT', 'NEUT', 'ALT', 'AST', 'ALP', 'TBIL', 'CREAT', 'BUN', 'GLUC', 'SODIUM', 'POTASSIUM')",
      "",
      "# Clinical significance thresholds",
      "clinical_thresholds <- list(",
      "  HGB = 'Low',",
      "  WBC = 'High',",
      "  PLT = 'Low',",
      "  NEUT = 'Low',",
      "  ALT = 'High',",
      "  AST = 'High',",
      "  ALP = 'High',",
      "  TBIL = 'High',",
      "  CREAT = 'High',",
      "  BUN = 'High',",
      "  GLUC = 'High',",
      "  SODIUM = 'Low',",
      "  POTASSIUM = 'High'",
      ")",
      "",
      "# Create shift tables for all parameters",
      "shift_results <- list()",
      "for (param in lab_params) {",
      "  shift_results[[param]] <- create_shift_table(shift_data, param)",
      "}",
      "",
      "# Calculate risk differences for clinically significant shifts",
      "risk_diff_results <- list()",
      "for (param in lab_params) {",
      "  threshold <- clinical_thresholds[[param]]",
      "  clinically_significant_shifts <- c(",
      "    paste('Normal →', threshold),",
      "    paste('Low →', threshold),",
      "    paste('High →', threshold)",
      "  )",
      "  ",
      "  risk_diffs <- data.frame()",
      "  for (shift in clinically_significant_shifts) {",
      "    risk_diff <- calculate_risk_differences(shift_results[[param]], shift)",
      "    if (nrow(risk_diff) > 0) {",
      "      risk_diff$shift_category <- shift",
      "      risk_diffs <- rbind(risk_diffs, risk_diff)",
      "    }",
      "  }",
      "  ",
      "  risk_diff_results[[param]] <- risk_diffs",
      "}"
    ],
    "table_generation": [
      "# Function to create laboratory shifts summary table",
      "create_lab_shifts_table <- function(shift_results, risk_diff_results, param_info) {",
      "  table_data <- data.frame()",
      "  ",
      "  for (param in names(shift_results)) {",
      "    shift_table <- shift_results[[param]]",
      "    risk_diffs <- risk_diff_results[[param]]",
      "    param_label <- param_info[[param]]$label",
      "    category <- param_info[[param]]$category",
      "    ",
      "    # Get clinically significant shifts",
      "    threshold <- clinical_thresholds[[param]]",
      "    clinically_significant_shifts <- c(",
      "      paste('Normal →', threshold),",
      "      paste('Low →', threshold),",
      "      paste('High →', threshold)",
      "    )",
      "    ",
      "    for (shift in clinically_significant_shifts) {",
      "      shift_data <- shift_table %>% filter(SHIFT_CATEGORY == shift)",
      "      ",
      "      if (nrow(shift_data) > 0) {",
      "        # Treatment A",
      "        trt_a <- shift_data %>% filter(TRT01P == 'Treatment A')",
      "        trt_a_rate <- ifelse(nrow(trt_a) > 0, sprintf('%d/%d (%.1f%%)', trt_a$n_shifts, trt_a$total_n, trt_a$percentage), '0/0 (0.0%)')",
      "        ",
      "        # Treatment B",
      "        trt_b <- shift_data %>% filter(TRT01P == 'Treatment B')",
      "        trt_b_rate <- ifelse(nrow(trt_b) > 0, sprintf('%d/%d (%.1f%%)', trt_b$n_shifts, trt_b$total_n, trt_b$percentage), '0/0 (0.0%)')",
      "        ",
      "        # Placebo",
      "        placebo <- shift_data %>% filter(TRT01P == 'Placebo')",
      "        placebo_rate <- ifelse(nrow(placebo) > 0, sprintf('%d/%d (%.1f%%)', placebo$n_shifts, placebo$total_n, placebo$percentage), '0/0 (0.0%)')",
      "        ",
      "        # Risk differences",
      "        risk_diff_data <- risk_diffs %>% filter(shift_category == shift)",
      "        ",
      "        trt_a_rd <- risk_diff_data %>% filter(TRT01P == 'Treatment A')",
      "        trt_a_rd_ci <- ifelse(nrow(trt_a_rd) > 0, sprintf('%.3f (%.3f, %.3f)', trt_a_rd$risk_diff, trt_a_rd$ci_lower, trt_a_rd$ci_upper), 'N/A')",
      "        trt_a_p <- ifelse(nrow(trt_a_rd) > 0, sprintf('%.4f', trt_a_rd$p_value), 'N/A')",
      "        ",
      "        trt_b_rd <- risk_diff_data %>% filter(TRT01P == 'Treatment B')",
      "        trt_b_rd_ci <- ifelse(nrow(trt_b_rd) > 0, sprintf('%.3f (%.3f, %.3f)', trt_b_rd$risk_diff, trt_b_rd$ci_lower, trt_b_rd$ci_upper), 'N/A')",
      "        trt_b_p <- ifelse(nrow(trt_b_rd) > 0, sprintf('%.4f', trt_b_rd$p_value), 'N/A')",
      "        ",
      "        # Clinical significance",
      "        clinical_assessment <- ifelse(any(risk_diff_data$risk_diff > 0.05), 'Yes', 'No')",
      "        ",
      "        # Add to table data",
      "        row_data <- data.frame(",
      "          Parameter = param_label,",
      "          Category = category,",
      "          Shift_Category = shift,",
      "          Treatment_A = trt_a_rate,",
      "          Treatment_B = trt_b_rate,",
      "          Placebo = placebo_rate,",
      "          Treatment_A_vs_Placebo = trt_a_rd_ci,",
      "          Treatment_B_vs_Placebo = trt_b_rd_ci,",
      "          Clinically_Significant = clinical_assessment",
      "        )",
      "        ",
      "        table_data <- rbind(table_data, row_data)",
      "      }",
      "    }",
      "  }",
      "  ",
      "  return(table_data)",
      "}",
      "",
      "# Parameter information",
      "param_info <- list(",
      "  HGB = list(label = 'Hemoglobin', category = 'Hematology'),",
      "  WBC = list(label = 'White Blood Cell Count', category = 'Hematology'),",
      "  PLT = list(label = 'Platelet Count', category = 'Hematology'),",
      "  NEUT = list(label = 'Neutrophil Count', category = 'Hematology'),",
      "  ALT = list(label = 'Alanine Aminotransferase', category = 'Chemistry'),",
      "  AST = list(label = 'Aspartate Aminotransferase', category = 'Chemistry'),",
      "  ALP = list(label = 'Alkaline Phosphatase', category = 'Chemistry'),",
      "  TBIL = list(label = 'Total Bilirubin', category = 'Chemistry'),",
      "  CREAT = list(label = 'Creatinine', category = 'Chemistry'),",
      "  BUN = list(label = 'Blood Urea Nitrogen', category = 'Chemistry'),",
      "  GLUC = list(label = 'Glucose', category = 'Chemistry'),",
      "  SODIUM = list(label = 'Sodium', category = 'Chemistry'),",
      "  POTASSIUM = list(label = 'Potassium', category = 'Chemistry')",
      ")",
      "",
      "# Generate table",
      "lab_shifts_table_data <- create_lab_shifts_table(shift_results, risk_diff_results, param_info)",
      "",
      "# Create formatted table",
      "lab_shifts_table <- lab_shifts_table_data %>%",
      "  gt() %>%",
      "  tab_header(",
      "    title = 'Table 14.3.5 Laboratory Shifts Analysis',",
      "    subtitle = 'Normal to Abnormal Shift Tables by Treatment Group'",
      "  ) %>%",
      "  cols_label(",
      "    Parameter = 'Parameter',",
      "    Category = 'Category',",
      "    Shift_Category = 'Shift Category',",
      "    Treatment_A = 'Treatment A<br>n/N (%)',",
      "    Treatment_B = 'Treatment B<br>n/N (%)',",
      "    Placebo = 'Placebo<br>n/N (%)',",
      "    Treatment_A_vs_Placebo = 'Treatment A vs Placebo<br>Risk Difference (95% CI)',",
      "    Treatment_B_vs_Placebo = 'Treatment B vs Placebo<br>Risk Difference (95% CI)',",
      "    Clinically_Significant = 'Clinically Significant'",
      "  ) %>%",
      "  tab_style(",
      "    style = cell_text(weight = 'bold'),",
      "    locations = cells_column_labels()",
      "  ) %>%",
      "  tab_style(",
      "    style = cell_borders(",
      "      sides = 'bottom',",
      "      weight = px(2)",
      "    ),",
      "    locations = cells_body(",
      "      rows = c(3, 6, 9, 12, 15, 18, 21, 24, 27, 30, 33, 36, 39)",
      "    )",
      "  ) %>%",
      "  fmt_markdown(columns = everything()) %>%",
      "  tab_footnote(",
      "    footnote = 'Safety Population: All randomized subjects who received at least one dose of study drug',",
      "    locations = cells_title()",
      "  ) %>%",
      "  tab_footnote(",
      "    footnote = 'Shift: Change from baseline to post-baseline reference range category',",
      "    locations = cells_title()",
      "  ) %>%",
      "  tab_footnote(",
      "    footnote = 'Risk Difference: Difference in shift rates between treatment groups',",
      "    locations = cells_title()",
      "  ) %>%",
      "  tab_footnote(",
      "    footnote = 'Clinically significant: Shifts to abnormal values requiring clinical attention',",
      "    locations = cells_title()",
      "  )",
      "",
      "# Display table",
      "lab_shifts_table"
    ],
    "quality_checks": [
      "# Data validation checks",
      "data_validation <- shift_data %>%",
      "  group_by(PARAMCD, TRT01P) %>%",
      "  summarise(",
      "    n_subjects = n_distinct(USUBJID),",
      "    missing_baseline = sum(is.na(BASELINE_ANRIND)),",
      "    missing_post = sum(is.na(POST_ANRIND)),",
      "    missing_rate = (missing_baseline + missing_post) / (n_subjects * 2),",
      "    .groups = 'drop'",
      "  ) %>%",
      "  filter(missing_rate > 0.1)",
      "",
      "# Statistical validation",
      "statistical_validation <- list()",
      "for (param in lab_params) {",
      "  shift_table <- shift_results[[param]]",
      "  ",
      "  # Check for sufficient sample sizes",
      "  sample_sizes <- shift_table %>%",
      "    group_by(TRT01P) %>%",
      "    summarise(",
      "      total_n = first(total_n),",
      "      min_cell_count = min(n_shifts),",
      "      .groups = 'drop'",
      "    )",
      "  ",
      "  # Check for expected cell counts (for chi-square test)",
      "  expected_counts <- shift_table %>%",
      "    group_by(SHIFT_CATEGORY) %>%",
      "    summarise(",
      "      total_shift = sum(n_shifts),",
      "      .groups = 'drop'",
      "    ) %>%",
      "    mutate(",
      "      expected_count = total_shift / 3,  # Assuming 3 treatment groups",
      "      chi_square_valid = expected_count >= 5",
      "    )",
      "  ",
      "  statistical_validation[[param]] <- list(",
      "    sample_sizes = sample_sizes,",
      "    expected_counts = expected_counts,",
      "    chi_square_valid = all(expected_counts$chi_square_valid)",
      "  )",
      "}",
      "",
      "# Clinical validation",
      "clinical_validation <- list()",
      "for (param in lab_params) {",
      "  risk_diffs <- risk_diff_results[[param]]",
      "  threshold <- clinical_thresholds[[param]]",
      "  ",
      "  # Check for clinically significant shifts",
      "  clinically_significant_shifts <- risk_diffs %>%",
      "    filter(abs(risk_diff) >= 0.05) %>%",
      "    nrow()",
      "  ",
      "  # Check for shifts to abnormal values",
      "  abnormal_shifts <- risk_diffs %>%",
      "    filter(str_detect(shift_category, paste('→', threshold))) %>%",
      "    nrow()",
      "  ",
      "  clinical_validation[[param]] <- list(",
      "    clinically_significant_count = clinically_significant_shifts,",
      "    abnormal_shift_count = abnormal_shifts,",
      "    clinical_threshold = threshold",
      "  )",
      "}",
      "",
      "# Reference range validation",
      "reference_validation <- list()",
      "for (param in lab_params) {",
      "  param_data <- analysis_data %>% filter(PARAMCD == param)",
      "  ",
      "  # Check reference range completeness",
      "  ref_range_completeness <- param_data %>%",
      "    group_by(TRT01P, AVISIT) %>%",
      "    summarise(",
      "      n_total = n(),",
      "      n_with_ref = sum(!is.na(ANRIND)),",
      "      completeness_rate = n_with_ref / n_total * 100,",
      "      .groups = 'drop'",
      "    )",
      "  ",
      "  # Check reference range categories",
      "  ref_categories <- param_data %>%",
      "    filter(!is.na(ANRIND)) %>%",
      "    group_by(ANRIND) %>%",
      "    summarise(",
      "      n_cases = n(),",
      "      .groups = 'drop'",
      "    )",
      "  ",
      "  reference_validation[[param]] <- list(",
      "    completeness = ref_range_completeness,",
      "    categories = ref_categories",
      "  )",
      "}",
      "",
      "# Print validation results",
      "cat('Data Validation:\\n')",
      "print(data_validation)",
      "cat('\\nStatistical Validation:\\n')",
      "print(statistical_validation)",
      "cat('\\nClinical Validation:\\n')",
      "print(clinical_validation)",
      "cat('\\nReference Range Validation:\\n')",
      "print(reference_validation)"
    ],
    "export_functions": [
      "# Export laboratory shifts analysis results",
      "export_lab_shifts_results <- function(table_data, shift_results, risk_diff_results, output_dir = 'output') {",
      "  # Create output directory",
      "  if (!dir.exists(output_dir)) {",
      "    dir.create(output_dir, recursive = TRUE)",
      "  }",
      "  ",
      "  # Export HTML table",
      "  html_file <- file.path(output_dir, 'lab_shifts_table.html')",
      "  lab_shifts_table %>%",
      "    gtsave(html_file)",
      "  ",
      "  # Export RTF table",
      "  rtf_file <- file.path(output_dir, 'lab_shifts_table.rtf')",
      "  lab_shifts_table_data %>%",
      "    flextable() %>%",
      "    set_header_labels(",
      "      Parameter = 'Parameter',",
      "      Category = 'Category',",
      "      Shift_Category = 'Shift Category',",
      "      Treatment_A = 'Treatment A\\nn/N (%)',",
      "      Treatment_B = 'Treatment B\\nn/N (%)',",
      "      Placebo = 'Placebo\\nn/N (%)',",
      "      Treatment_A_vs_Placebo = 'Treatment A vs Placebo\\nRisk Difference (95% CI)',",
      "      Treatment_B_vs_Placebo = 'Treatment B vs Placebo\\nRisk Difference (95% CI)',",
      "      Clinically_Significant = 'Clinically Significant'",
      "    ) %>%",
      "    autofit() %>%",
      "    save_as_rtf(rtf_file)",
      "  ",
      "  # Export results summary",
      "  summary_file <- file.path(output_dir, 'lab_shifts_summary.txt')",
      "  sink(summary_file)",
      "  cat('Laboratory Shifts Analysis Summary\\n')",
      "  cat('==================================\\n\\n')",
      "  ",
      "  for (param in names(shift_results)) {",
      "    cat(sprintf('Parameter: %s\\n', param))",
      "    ",
      "    # Print shift table summary",
      "    shift_summary <- shift_results[[param]] %>%",
      "      group_by(TRT01P) %>%",
      "      summarise(",
      "        total_subjects = first(total_n),",
      "        total_shifts = sum(n_shifts),",
      "        .groups = 'drop'",
      "      )",
      "    print(shift_summary)",
      "    ",
      "    # Print risk differences",
      "    if (nrow(risk_diff_results[[param]]) > 0) {",
      "      cat('Risk Differences:\\n')",
      "      print(risk_diff_results[[param]])",
      "    }",
      "    ",
      "    cat('\\n')",
      "  }",
      "  ",
      "  cat('Statistical Method: Shift Table Analysis\\n')",
      "  cat('Population: Safety Population\\n')",
      "  cat('Significance Level: 0.05\\n')",
      "  cat('Clinical Significance: Shifts to abnormal values requiring clinical attention\\n')",
      "  sink()",
      "  ",
      "  cat('Exported files to:', output_dir, '\\n')",
      "}",
      "",
      "# Export results",
      "export_lab_shifts_results(lab_shifts_table_data, shift_results, risk_diff_results)"
    ]
  },
  "keywords": [
    "laboratory shifts",
    "shift table analysis",
    "normal to abnormal",
    "reference ranges",
    "hematology",
    "chemistry",
    "risk difference",
    "clinical significance",
    "safety monitoring",
    "FDA compliance",
    "ICH E3",
    "clinical trial",
    "statistical analysis"
  ],
  "metadata": {
    "created_date": "2024-08-06",
    "version": "1.0",
    "author": "Jaime Yan",
    "description": "FDA-compliant laboratory shifts analysis template with detailed structure and complete R code",
    "references": [
      "ICH E3 Guidelines Section 14.3.5",
      "FDA Guidance for Industry: E3 Structure and Content of Clinical Study Reports",
      "CDISC ADaM Implementation Guide",
      "Laboratory Safety Monitoring Guidelines",
      "Statistical Analysis Plan Template"
    ],
    "data_requirements": [
      "ADSL dataset with SAFFL flag",
      "ADLB dataset with laboratory variables",
      "Laboratory variables: HGB, WBC, PLT, NEUT, ALT, AST, ALP, TBIL, CREAT, BUN, GLUC, SODIUM, POTASSIUM",
      "Reference range information: ANRIND",
      "Visit information: AVISIT (Baseline, Week 12)",
      "Treatment assignment: TRT01P"
    ],
    "statistical_methods": [
      "Shift table analysis for reference range transitions",
      "Risk differences with 95% confidence intervals",
      "Chi-square test or Fisher's exact test for significance",
      "Clinical significance assessment using pre-specified thresholds",
      "Reference range validation and completeness checks"
    ]
  }
} 